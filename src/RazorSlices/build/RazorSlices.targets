<Project>
  <Target Name="_CheckRazorSlicesDeps" AfterTargets="CollectPackageReferences">
    <Error Text="Razor Slices requires Razor support for MVC to be enabled. Ensure the project is using the Microsoft.NET.Sdk.Web or Microsoft.NET.Sdk.Razor SDK and that the AddRazorSupportForMvc property is set to 'true'."
           Condition=" '$(AddRazorSupportForMvc)' != 'true' " />
  </Target>
  
  <Target Name="ResolveRazorSlicesInputs" AfterTargets="ResolveRazorGenerateInputs" DependsOnTargets="_CheckRazorSlicesDeps">
    
    <!-- First, collect files that should have GenerateRazorSlice=true -->
    <ItemGroup Condition=" '$(EnableDefaultRazorSlices)' == 'true' ">
      <_RazorGenerateWithSlice Include="@(RazorGenerate)"
                               Condition=" '%(Filename)' != '_ViewImports' AND '%(Filename)' != '_ViewStart' " />
    </ItemGroup>

    <!-- Also include any explicitly specified RazorSlice items -->
    <ItemGroup Condition=" '@(RazorSlice)' != '' ">
      <_RazorGenerateWithSlice Include="@(RazorSlice)" />
    </ItemGroup>

    <!-- Remove the original RazorGenerate items that match our slice files -->
    <ItemGroup>
      <RazorGenerate Remove="@(_RazorGenerateWithSlice)" />
    </ItemGroup>

    <!-- Add them back with the GenerateRazorSlice metadata -->
    <ItemGroup>
      <RazorGenerate Include="@(_RazorGenerateWithSlice)"
                     GenerateRazorSlice="true"
                     ExcludeFromSingleFile="true"
                     CopyToPublishDirectory="PreserveNewest" />

      <!-- Make the RazorGenerate item type and GenerateRazorSlice item metadata visible to the source generator -->
      <CompilerVisibleItemMetadata Include="RazorGenerate" MetadataName="GenerateRazorSlice" />
    </ItemGroup>
  </Target>

</Project>
